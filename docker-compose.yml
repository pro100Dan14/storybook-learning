services:
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: storybook-backend
    ports:
      - "8787:8787"
    environment:
      # Node environment
      # Using development mode to allow identity guard to skip gracefully if dependencies unavailable
      - NODE_ENV=development
      
      # Gemini API configuration
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_TEXT_MODEL=${GEMINI_TEXT_MODEL:-gemini-2.5-flash}
      - GEMINI_IMAGE_MODEL=${GEMINI_IMAGE_MODEL:-gemini-2.5-flash-image}
      
      # Provider configuration
      - PROVIDER_TEXT=${PROVIDER_TEXT:-gemini}
      - PROVIDER_IMAGE=${PROVIDER_IMAGE:-gemini}
      
      # Gemini API configuration (for text generation)
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_TEXT_MODEL=${GEMINI_TEXT_MODEL:-gemini-2.5-flash}

      # BytePlus Seedream configuration
      - BYTEPLUS_API_KEY=${BYTEPLUS_API_KEY:-}
      - BYTEPLUS_BASE_URL=${BYTEPLUS_BASE_URL:-https://ark.ap-southeast.bytepluses.com}
      - BYTEPLUS_MODEL=${BYTEPLUS_MODEL:-seedream-4-5-251128}
      - BYTEPLUS_SIZE=${BYTEPLUS_SIZE:-2048x2048}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-https://api.projectt988.com}
      - DISABLE_LEGACY_IMAGE=${DISABLE_LEGACY_IMAGE:-true}
      
      # Google Cloud credentials (if using ADC instead of API key)
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-sa.json}
      
      # FaceID configuration
      - FACE_ID_ENABLED=${FACE_ID_ENABLED:-true}
      - FACE_ID_THRESHOLD=${FACE_ID_THRESHOLD:-0.32}
      - FACE_ID_MAX_ATTEMPTS=${FACE_ID_MAX_ATTEMPTS:-3}
      - PYTHON_BIN=${PYTHON_BIN:-python3}
      
      # Identity configuration
      - IDENTITY_SIMILARITY_THRESHOLD=${IDENTITY_SIMILARITY_THRESHOLD:-0.62}
      
      # Debug flags
      - DEBUG_BOOK=${DEBUG_BOOK:-0}
      - DEBUG_FACE_ID=${DEBUG_FACE_ID:-false}
    volumes:
      # Mount jobs directory to persist generated content
      - ./server/jobs:/app/jobs
      # Mount gcp-sa.json if using ADC (optional - file may not exist)
      # Uncomment the line below if you have gcp-sa.json file
      # - ./server/gcp-sa.json:/app/gcp-sa.json:ro
    restart: unless-stopped
    networks:
      - storybook-network

networks:
  storybook-network:
    driver: bridge

