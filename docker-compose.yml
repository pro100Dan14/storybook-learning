services:
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: storybook-backend
    ports:
      - "8787:8787"
    environment:
      # Node environment
      # Using development mode to allow identity guard to skip gracefully if dependencies unavailable
      - NODE_ENV=development
      
      # Gemini API configuration
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_TEXT_MODEL=${GEMINI_TEXT_MODEL:-gemini-2.5-flash}
      - GEMINI_IMAGE_MODEL=${GEMINI_IMAGE_MODEL:-gemini-2.5-flash-image}
      
      # Provider configuration
      - PROVIDER_TEXT=${PROVIDER_TEXT:-gemini}
      - PROVIDER_IMAGE=${PROVIDER_IMAGE:-gemini}
      
      # InstantID / Replicate configuration (for better face identity)
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN:-}
      - INSTANTID_MODEL=${INSTANTID_MODEL:-zsxkib/instant-id}
      - ILLUSTRATION_PIPELINE=${ILLUSTRATION_PIPELINE:-auto}
      - INSTANTID_ENABLED=${INSTANTID_ENABLED:-true}
      - V3_SIMILARITY_THRESHOLD=${V3_SIMILARITY_THRESHOLD:-0.4}
      - V3_MAX_PAGE_RETRIES=${V3_MAX_PAGE_RETRIES:-2}
      
      # Google Cloud credentials (if using ADC instead of API key)
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-sa.json}
      
      # FaceID configuration
      - FACE_ID_ENABLED=${FACE_ID_ENABLED:-true}
      - FACE_ID_THRESHOLD=${FACE_ID_THRESHOLD:-0.32}
      - FACE_ID_MAX_ATTEMPTS=${FACE_ID_MAX_ATTEMPTS:-3}
      - PYTHON_BIN=${PYTHON_BIN:-python3}
      
      # Identity configuration
      - IDENTITY_SIMILARITY_THRESHOLD=${IDENTITY_SIMILARITY_THRESHOLD:-0.62}
      
      # Debug flags
      - DEBUG_BOOK=${DEBUG_BOOK:-0}
      - DEBUG_FACE_ID=${DEBUG_FACE_ID:-false}
    volumes:
      # Mount jobs directory to persist generated content
      - ./server/jobs:/app/jobs
      # Mount gcp-sa.json if using ADC (optional - file may not exist)
      # Uncomment the line below if you have gcp-sa.json file
      # - ./server/gcp-sa.json:/app/gcp-sa.json:ro
    restart: unless-stopped
    networks:
      - storybook-network

networks:
  storybook-network:
    driver: bridge

