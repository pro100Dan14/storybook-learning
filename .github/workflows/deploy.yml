name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/storybook-learning' }}"
            cd "$DEPLOY_PATH"
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p "$DEPLOY_PATH"
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub
            if [ -d .git ]; then
              git fetch origin
              git reset --hard origin/${{ github.ref_name }}
              git clean -fd
            else
              git clone https://github.com/${{ github.repository }}.git .
              git checkout ${{ github.ref_name }}
            fi
            
            # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Docker
            if [ -f docker-compose.yml ]; then
              echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Docker..."
              
              # –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
              if [ -d web ]; then
                echo "üì¶ –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                cd web
                npm install --production=false
                npm run build
                cd ..
                echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω"
              fi
              
              # –ö–æ–ø–∏—Ä—É–µ–º .env –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º)
              if [ -f .env ]; then
                echo "‚úÖ .env —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π"
              fi
              
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              docker-compose down || true
              
              # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
              docker-compose build --no-cache
              docker-compose up -d
              
              # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
              sleep 5
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º health
              curl -f http://localhost:8787/health || echo "‚ö†Ô∏è Health check failed, –Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
              
              echo "‚úÖ –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Docker –∑–∞–≤–µ—Ä—à–µ–Ω"
            else
              # –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Docker - –æ–±—ã—á–Ω—ã–π Node.js –¥–µ–ø–ª–æ–π
              echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Node.js..."
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
              if [ -f package.json ]; then
                npm install --production
              fi
              
              if [ -d server ] && [ -f server/package.json ]; then
                cd server
                npm install --production
                cd ..
              fi
              
              # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2 –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
              if command -v pm2 &> /dev/null; then
                pm2 restart storybook-backend || pm2 start server/index.js --name storybook-backend
                pm2 save
              else
                echo "‚ö†Ô∏è PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∑–∞–ø—É—Å–∫–∞ (systemd, supervisor, etc.)"
              fi
              
              echo "‚úÖ –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Node.js –∑–∞–≤–µ—Ä—à–µ–Ω"
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
          fi

